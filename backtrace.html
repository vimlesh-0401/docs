<div class="card csv-section"><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ruby Exception Backtrace — Visual Kit</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --primary-bg: #0f0f0f;
      --surface-bg: #1a1a1a;
      --card-bg: #242424;
      --border-color: #333;
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent-red: #ff4757;
      --accent-blue: #2ed573;
      --accent-purple: #5352ed;
      --accent-orange: #ffa502;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--primary-bg);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .hero-section {
      background: var(--gradient-1);
      padding: 60px 0;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      0% { transform: translateY(0px) rotate(0deg); }
      100% { transform: translateY(-100px) rotate(360deg); }
    }

    .hero-content {
      position: relative;
      z-index: 2;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .hero-title {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 800;
      margin-bottom: 16px;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .hero-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 30px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-bottom: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 50px;
      border: 2px solid transparent;
      background: var(--card-bg);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--gradient-2);
      transition: left 0.3s ease;
      z-index: -1;
    }

    .btn:hover::before {
      left: 0;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--accent-purple);
    }

    .btn:active {
      transform: translateY(0);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 40px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-3);
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      border-color: var(--accent-blue);
    }

    .card h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent-red);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .mermaid {
      background: var(--surface-bg);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .svg-container {
      background: var(--surface-bg);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .table-section {
      grid-column: 1 / -1;
    }

    .table-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      align-items: start;
    }

    .table-wrap {
      max-height: 800px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--surface-bg);
    }

    .table-wrap::-webkit-scrollbar {
      width: 8px;
    }

    .table-wrap::-webkit-scrollbar-track {
      background: var(--surface-bg);
    }

    .table-wrap::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 16px 8px;
      text-align: left;
      vertical-align: top;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }

    th {
      background: var(--card-bg);
      font-weight: 700;
      color: var(--accent-blue);
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .quick-ref {
      background: var(--surface-bg);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .quick-ref h3 {
      color: var(--accent-orange);
      margin-bottom: 16px;
      font-size: 1.2rem;
    }

    .quick-ref ul {
      list-style: none;
      padding: 0;
    }

    .quick-ref li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      color: var(--text-secondary);
    }

    .quick-ref li:last-child {
      border-bottom: none;
    }

    .quick-ref code {
      background: var(--card-bg);
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--accent-purple);
      font-family: 'JetBrains Mono', monospace;
    }

    .csv-section {
      grid-column: 1 / -1;
      margin-top: 40px;
    }

    .csv-editor {
      width: 100%;
      height: 300px;
      font-family: 'JetBrains Mono', monospace;
      padding: 20px;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--surface-bg);
      color: var(--text-primary);
      font-size: 13px;
      resize: vertical;
      transition: border-color 0.3s ease;
    }

    .csv-editor:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(46, 213, 115, 0.2);
    }

    @media (max-width: 768px) {
      .hero-section {
        padding: 40px 0;
      }
      
      .container {
        padding: 20px 10px;
      }
      
      .grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .table-container {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 20px;
      }
      
      .controls {
        justify-content: center;
      }
      
      .btn {
        font-size: 12px;
        padding: 10px 20px;
      }
    }

    /* Introduction section styles */
    .intro-section {
      margin-bottom: 50px;
    }

    .intro-content {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 40px;
      align-items: start;
    }

    .intro-text h2 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 20px;
      background: var(--gradient-2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .intro-text h3 {
      color: var(--accent-blue);
      font-size: 1.3rem;
      margin: 30px 0 15px 0;
      font-weight: 600;
    }

    .intro-text p {
      font-size: 1.1rem;
      line-height: 1.7;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .highlight-box {
      background: linear-gradient(135deg, rgba(83, 82, 237, 0.1), rgba(255, 71, 87, 0.1));
      border: 1px solid var(--accent-purple);
      border-radius: 16px;
      padding: 24px;
      margin: 30px 0;
      position: relative;
      overflow: hidden;
    }

    .highlight-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-1);
    }

    .highlight-box h3 {
      margin-top: 0 !important;
      color: var(--accent-orange);
    }

    .highlight-box ul {
      list-style: none;
      padding: 0;
      margin: 15px 0 0 0;
    }

    .highlight-box li {
      padding: 8px 0;
      position: relative;
      padding-left: 24px;
      color: var(--text-secondary);
    }

    .highlight-box li::before {
      content: '→';
      position: absolute;
      left: 0;
      color: var(--accent-blue);
      font-weight: bold;
    }

    .code-example {
      background: var(--primary-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      overflow: hidden;
      margin: 25px 0;
    }

    .code-header {
      background: var(--card-bg);
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-red);
      border-bottom: 1px solid var(--border-color);
    }

    .code-example pre {
      margin: 0;
      padding: 20px;
      font-size: 14px;
      line-height: 1.5;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
      overflow-x: auto;
    }

    .stack-illustration {
      background: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .stack-illustration h3 {
      color: var(--accent-orange);
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .stack-frames {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .frame {
      display: flex;
      align-items: center;
      background: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      width: 100%;
      max-width: 280px;
      transition: all 0.3s ease;
      position: relative;
    }

    .frame:hover {
      transform: translateX(8px);
      border-color: var(--accent-blue);
    }

    .frame.error {
      border-color: var(--accent-red);
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), var(--card-bg));
    }

    .frame.error:hover {
      border-color: var(--accent-red);
      box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
    }

    .frame-number {
      background: var(--accent-purple);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      margin-right: 12px;
      flex-shrink: 0;
    }

    .frame.error .frame-number {
      background: var(--accent-red);
      animation: pulse 2s infinite;
    }

    .frame-content {
      text-align: left;
      flex-grow: 1;
    }

    .frame-content strong {
      display: block;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 2px;
    }

    .frame-content small {
      color: var(--text-muted);
      font-size: 12px;
    }

    .stack-arrow {
      color: var(--accent-blue);
      font-weight: bold;
      font-size: 14px;
      margin: 4px 0;
    }

    .stack-note {
      margin-top: 20px;
      padding: 12px;
      background: rgba(46, 213, 115, 0.1);
      border-radius: 8px;
      border-left: 4px solid var(--accent-blue);
    }

    .stack-note small {
      color: var(--text-secondary);
      font-size: 13px;
    }

    @media (max-width: 968px) {
      .intro-content {
        grid-template-columns: 1fr;
        gap: 30px;
      }
      
      .intro-text h2 {
        font-size: 1.8rem;
      }
      
      .frame {
        max-width: none;
      }
    }
    .examples-section {
      grid-column: 1 / -1;
      margin-bottom: 40px;
    }

    .examples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .example-card {
      background: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .example-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-blue);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .example-card.span-2 {
      grid-column: span 2;
    }

    .example-card h4 {
      color: var(--accent-orange);
      margin-bottom: 12px;
      font-size: 1rem;
      font-weight: 600;
    }

    .code-block {
      background: var(--primary-bg);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .file-header {
      background: var(--card-bg);
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
      font-family: 'JetBrains Mono', monospace;
    }

    .code-block pre {
      margin: 0;
      padding: 16px;
      font-size: 13px;
      line-height: 1.4;
      overflow-x: auto;
    }

    .code-block code {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      color: var(--text-primary);
    }

    .code-block code.ruby { color: #ff6b8a; }
    .code-block code.c { color: #4facfe; }
    .code-block code.bash { color: #2ed573; }

    /* Diagram explanation styles */
    .diagram-explanation {
      background: rgba(83, 82, 237, 0.1);
      border: 1px solid rgba(83, 82, 237, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .diagram-explanation p {
      color: var(--text-secondary);
      margin-bottom: 15px;
      font-size: 14px;
      line-height: 1.6;
    }

    .explanation-points {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .point {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
      border-left: 3px solid var(--accent-blue);
    }

    .step-num {
      background: var(--accent-blue);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-content strong {
      color: var(--text-primary);
      font-size: 13px;
    }

    .step-content code {
      background: var(--card-bg);
      padding: 2px 4px;
      border-radius: 3px;
      color: var(--accent-purple);
      font-size: 12px;
    }

    .flow-legend {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 15px 0;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .legend-arrow {
      color: var(--accent-purple);
      font-weight: bold;
      font-size: 16px;
    }

    .class-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .class-info {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid var(--accent-orange);
    }

    .class-info h4 {
      color: var(--accent-orange);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .class-info p {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .class-info ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .class-info li {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 3px 0;
      padding-left: 15px;
      position: relative;
    }

    .class-info li::before {
      content: '•';
      position: absolute;
      left: 0;
      color: var(--accent-blue);
    }

    .class-info code {
      background: var(--card-bg);
      padding: 1px 3px;
      border-radius: 2px;
      color: var(--accent-purple);
      font-size: 11px;
    }

    .compact-insights {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .insight {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
    }

    .insight-icon {
      font-size: 18px;
      flex-shrink: 0;
    }

    .insight div {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .insight strong {
      color: var(--accent-green);
    }

    .examples-intro {
      background: linear-gradient(135deg, rgba(255, 107, 138, 0.1), rgba(79, 172, 254, 0.1));
      border: 1px solid var(--accent-blue);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      text-align: center;
    }

    .examples-intro p {
      color: var(--text-secondary);
      font-size: 14px;
      margin: 0;
      line-height: 1.6;
    }

    .example-explanation {
      background: rgba(255, 165, 2, 0.1);
      border: 1px solid rgba(255, 165, 2, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .example-explanation p {
      color: var(--text-secondary);
      font-size: 13px;
      margin: 0;
      line-height: 1.5;
    }

    .example-explanation strong {
      color: var(--accent-orange);
    }

    @media (max-width: 768px) {
      .explanation-points {
        gap: 10px;
      }
      
      .point {
        flex-direction: column;
        gap: 8px;
      }
      
      .class-breakdown {
        grid-template-columns: 1fr;
      }
      
      .compact-insights {
        gap: 8px;
      }
      
      .insight {
        flex-direction: column;
        text-align: center;
        gap: 8px;
      }
    }

    /* Enhanced SVG styles */
    .flow-svg {
      width: 100%;
      height: auto;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
    }

    .flow-svg .box {
      fill: var(--card-bg);
      stroke: var(--accent-blue);
      stroke-width: 2;
      rx: 12;
    }

    .flow-svg .text {
      fill: var(--text-primary);
      font-family: Inter, Arial, sans-serif;
      font-size: 14px;
      font-weight: 600;
    }

    .flow-svg .label {
      fill: var(--text-secondary);
      font-size: 12px;
    }

    .flow-svg .arrow {
      stroke: var(--accent-purple);
      stroke-width: 2;
      marker-end: url(#arrowhead);
    }
  </style>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ 
      startOnLoad: true, 
      theme: 'dark',
      themeVariables: {
        primaryColor: '#5352ed',
        primaryTextColor: '#ffffff',
        primaryBorderColor: '#333',
        lineColor: '#666',
        sectionBkgColor: '#242424',
        altSectionBkgColor: '#1a1a1a',
        gridColor: '#333',
        secondaryColor: '#ff4757',
        tertiaryColor: '#2ed573'
      }
    });
  </script>
</head>
<body>
  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Ruby Exception Backtrace</h1>
      <p class="hero-subtitle">Interactive Visual Kit — Deep Dive into Ruby's Exception Handling</p>
    </div>
  </div>

  <div class="container">
    <div class="intro-section">
      <div class="intro-content">
        <div class="intro-text">
          <h2>What is a Ruby Backtrace?</h2>
          <p>A <strong>backtrace</strong> (also called a <em>stack trace</em>) is Ruby's way of showing you exactly where an error occurred and how your program got there. When an exception is raised, Ruby captures a snapshot of the current call stack and presents it as an array of strings, each representing a method call in the execution path.</p>
          
          <div class="highlight-box">
            <h3>🎯 Why Backtraces Matter</h3>
            <ul>
              <li><strong>Debugging Power</strong> — Instantly see the execution path that led to an error</li>
              <li><strong>Call Stack Visibility</strong> — Understand how methods are calling each other</li>
              <li><strong>Error Context</strong> — Get file names, line numbers, and method names</li>
              <li><strong>Performance Analysis</strong> — Identify deep call stacks or recursive patterns</li>
            </ul>
          </div>
          
          <h3>How Ruby Creates Backtraces</h3>
          <p>Behind the scenes, Ruby's Virtual Machine (written in C) maintains a stack of <em>control frames</em> for every method call. When an exception occurs, the VM walks through these frames, extracts location information from each one, and formats them into the familiar backtrace format you see in your terminal.</p>
          
          <div class="code-example">
            <div class="code-header">🚨 Typical Backtrace Output</div>
            <pre><code>app/controllers/users_controller.rb:42:in `create'
app/models/user.rb:25:in `validate_email'
lib/email_validator.rb:18:in `check_format'
/usr/local/lib/ruby/gems/3.2.0/gems/mail-2.8.1/lib/mail.rb:123:in `parse'</code></pre>
          </div>
          
          <p>Each line tells you: <code><strong>filename:line_number:in `method_name'</strong></code></p>
        </div>
        
        <div class="intro-visual">
          <div class="stack-illustration">
            <h3>📚 Call Stack Visualization</h3>
            <div class="stack-frames">
              <div class="frame frame-1">
                <span class="frame-number">4</span>
                <div class="frame-content">
                  <strong>main</strong><br>
                  <small>program entry point</small>
                </div>
              </div>
              <div class="stack-arrow">↓ calls</div>
              <div class="frame frame-2">
                <span class="frame-number">3</span>
                <div class="frame-content">
                  <strong>create_user</strong><br>
                  <small>controller method</small>
                </div>
              </div>
              <div class="stack-arrow">↓ calls</div>
              <div class="frame frame-3">
                <span class="frame-number">2</span>
                <div class="frame-content">
                  <strong>validate!</strong><br>
                  <small>model validation</small>
                </div>
              </div>
              <div class="stack-arrow">↓ calls</div>
              <div class="frame frame-4 error">
                <span class="frame-number">1</span>
                <div class="frame-content">
                  <strong>check_email</strong><br>
                  <small>💥 exception raised here</small>
                </div>
              </div>
            </div>
            <div class="stack-note">
              <small>Ruby walks <strong>up</strong> the stack (4 → 3 → 2 → 1) to build the backtrace</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="toggleSeq" class="btn">🔄 Sequence Diagram</button>
      <button id="toggleFlow" class="btn">📊 Flow Diagram</button>
      <button id="toggleClass" class="btn">🏗️ Class Diagram</button>
      <button id="toggleCompact" class="btn">⚡ Compact Flow</button>
      <button id="downloadCsv" class="btn">📥 Download CSV</button>
    </div>

    <div class="grid">
      <div id="sequenceCard" class="card">
        <h2>Sequence Diagram</h2>
        <div class="diagram-explanation">
          <p><strong>Shows the chronological flow</strong> of how Ruby creates a backtrace when an exception occurs. Each arrow represents a function call or data flow between components.</p>
          <div class="explanation-points">
            <div class="point">
              <span class="step-num">1</span>
              <div class="step-content">
                <strong>Ruby Code → Ruby VM</strong><br>
                When <code>raise "error"</code> is executed, control passes from Ruby-land to the C-level VM via <code>rb_raise()</code>
              </div>
            </div>
            <div class="point">
              <span class="step-num">2</span>
              <div class="step-content">
                <strong>VM → Control Frames</strong><br>
                The VM accesses the current execution context and walks the control frame stack (<code>rb_control_frame_t</code> chain)
              </div>
            </div>
            <div class="point">
              <span class="step-num">3</span>
              <div class="step-content">
                <strong>Frames → Backtrace Builder</strong><br>
                Each frame's instruction sequence (iseq) is processed to extract file paths, line numbers, and method names
              </div>
            </div>
            <div class="point">
              <span class="step-num">4</span>
              <div class="step-content">
                <strong>Builder → Exception Object</strong><br>
                Location data is formatted into <code>Thread::Backtrace::Location</code> objects and attached to the exception
              </div>
            </div>
            <div class="point">
              <span class="step-num">5</span>
              <div class="step-content">
                <strong>Exception → Ruby Code</strong><br>
                The final backtrace array is returned to Ruby, accessible via <code>Exception#backtrace</code>
              </div>
            </div>
          </div>
        </div>
        <div class="mermaid">
sequenceDiagram
    participant RC as Ruby Code
    participant VM as Ruby VM (C)
    participant CF as Control Frames
    participant BB as Backtrace Builder
    participant EO as Exception Object

    RC->>+VM: raise "error"
    Note over VM: rb_raise / rb_exc_raise
    VM->>+CF: Snapshot call stack
    Note over CF: rb_control_frame_t
    CF->>+BB: Extract file/line/method
    Note over BB: vm_backtrace.c
    BB->>+EO: Build & stringify
    Note over EO: Exception#backtrace
    EO-->>-RC: Array String
    deactivate BB
    deactivate CF
    deactivate VM
        </div>
      </div>

      <div id="flowCard" class="card">
        <h2>Inline Flow Diagram</h2>
        <div class="diagram-explanation">
          <p><strong>Visualizes the data transformation pipeline</strong> from exception trigger to final backtrace. This SVG diagram shows how information flows through Ruby's internal systems.</p>
          <div class="flow-legend">
            <div class="legend-item">
              <div class="legend-color" style="background: var(--card-bg); border: 2px solid var(--accent-blue);"></div>
              <span>Internal Components - Each box represents a major system in Ruby's VM</span>
            </div>
            <div class="legend-item">
              <div class="legend-arrow">→</div>
              <span>Data Flow - Shows how exception data moves between components</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: var(--accent-purple); width: 12px; height: 2px;"></div>
              <span>Return Path - The final backtrace array flows back to the originating code</span>
            </div>
          </div>
          <p><em>Key insight:</em> Notice how the process forms a cycle - the exception data travels through multiple C-level components before returning as a Ruby array.</p>
        </div>
        <div class="svg-container">
          <svg viewBox="0 0 900 280" xmlns="http://www.w3.org/2000/svg" class="flow-svg">
            <defs>
              <marker id="arrowhead" markerWidth="12" markerHeight="8" refX="12" refY="4" orient="auto">
                <path d="M0,0 L12,4 L0,8 z" fill="#5352ed" />
              </marker>
            </defs>

            <rect x="20" y="20" width="160" height="70" class="box"/>
            <text x="100" y="45" class="text" text-anchor="middle">Ruby Code</text>
            <text x="100" y="65" class="label" text-anchor="middle">(raise "error")</text>

            <rect x="220" y="20" width="180" height="70" class="box"/>
            <text x="310" y="40" class="text" text-anchor="middle">Ruby VM (C)</text>
            <text x="310" y="55" class="label" text-anchor="middle">rb_raise /</text>
            <text x="310" y="70" class="label" text-anchor="middle">rb_exc_raise</text>

            <rect x="440" y="20" width="170" height="70" class="box"/>
            <text x="525" y="40" class="text" text-anchor="middle">Control Frames</text>
            <text x="525" y="60" class="label" text-anchor="middle">rb_control_frame_t</text>

            <rect x="650" y="20" width="190" height="70" class="box"/>
            <text x="745" y="40" class="text" text-anchor="middle">Backtrace Builder</text>
            <text x="745" y="60" class="label" text-anchor="middle">vm_backtrace.c</text>

            <rect x="340" y="140" width="220" height="70" class="box"/>
            <text x="450" y="165" class="text" text-anchor="middle">Exception Object</text>
            <text x="450" y="185" class="label" text-anchor="middle">Exception#backtrace</text>

            <line x1="180" y1="55" x2="220" y2="55" class="arrow"/>
            <line x1="400" y1="55" x2="440" y2="55" class="arrow"/>
            <line x1="610" y1="55" x2="650" y2="55" class="arrow"/>
            <line x1="730" y1="90" x2="480" y2="140" class="arrow"/>
            <line x1="420" y1="210" x2="120" y2="90" class="arrow"/>
          </svg>
        </div>
      </div>

      <div id="classCard" class="card">
        <h2>Class Diagram</h2>
        <div class="diagram-explanation">
          <p><strong>Shows the object-oriented structure</strong> of Ruby's backtrace system. This UML-style diagram reveals the relationships between classes and their responsibilities.</p>
          <div class="class-breakdown">
            <div class="class-info">
              <h4>📦 Exception Class</h4>
              <p>The main container for error information. Every Ruby exception inherits from this base class.</p>
              <ul>
                <li><code>message</code> - The error description string</li>
                <li><code>backtrace</code> - Array of location strings (what you see in logs)</li>
                <li><code>backtrace_locations</code> - Array of Location objects (richer data)</li>
              </ul>
            </div>
            <div class="class-info">
              <h4>🌍 Thread::Backtrace::Location Class</h4>
              <p>Represents a single frame in the call stack with detailed location information.</p>
              <ul>
                <li><code>path</code> - Full file path (/app/models/user.rb)</li>
                <li><code>lineno</code> - Exact line number where the call occurred</li>
                <li><code>label</code> - Method or block name (validate_email)</li>
              </ul>
            </div>
            <div class="class-info">
              <h4>🧵 Thread Class</h4>
              <p>Provides static methods to access backtrace information for any thread.</p>
              <ul>
                <li><code>current_backtrace</code> - Get current call stack</li>
                <li><code>backtrace</code> - Get formatted string array</li>
              </ul>
            </div>
          </div>
          <p><em>Relationship:</em> One Exception can contain many Location objects, forming a complete picture of the execution path.</p>
        </div>
        <div class="mermaid">
classDiagram
    class Exception {
        +String message
        +Array~String~ backtrace
        +Array~Location~ backtrace_locations
        +set_backtrace(Array) void
        +full_message() String
    }
    class Location {
        +String path
        +Integer lineno
        +String label
        +String to_s()
    }
    class Thread {
        +current_backtrace() Array~Location~
        +backtrace() Array~String~
    }
    
    Exception "1" --> "*" Location : contains
    Thread --> Exception : generates
        </div>
      </div>

      <div id="compactCard" class="card">
        <h2>Compact Flow</h2>
        <div class="diagram-explanation">
          <p><strong>Simplified view of the complete backtrace lifecycle.</strong> This flowchart emphasizes the circular nature of exception handling - from Ruby code back to Ruby code.</p>
          <div class="compact-insights">
            <div class="insight">
              <span class="insight-icon">🔄</span>
              <div>
                <strong>Circular Process:</strong> Exceptions start in Ruby code and return processed data back to Ruby code
              </div>
            </div>
            <div class="insight">
              <span class="insight-icon">⚡</span>
              <div>
                <strong>Speed Matters:</strong> This process happens in microseconds, even for deep call stacks
              </div>
            </div>
            <div class="insight">
              <span class="insight-icon">🎯</span>
              <div>
                <strong>No Data Loss:</strong> Every method call in the stack is captured and can be inspected
              </div>
            </div>
          </div>
          <p><em>Color coding:</em> Each step has a unique color to help you trace the flow visually. The return arrow completes the cycle.</p>
        </div>
        <div class="mermaid">
flowchart TD
    A[🐛 Ruby Code<br/>raise 'error'] --> B[⚙️ Ruby VM<br/>rb_raise]
    B --> C[📚 Control Frames<br/>rb_control_frame_t]
    C --> D[🔧 Backtrace Builder<br/>vm_backtrace.c]
    D --> E[📦 Exception Object<br/>with backtrace]
    E --> F[🔄 Return to Ruby<br/>Array&lt;String&gt;]
    F --> A
    
    style A fill:#ff4757,stroke:#fff,stroke-width:2px,color:#fff
    style B fill:#5352ed,stroke:#fff,stroke-width:2px,color:#fff
    style C fill:#2ed573,stroke:#fff,stroke-width:2px,color:#fff
    style D fill:#ffa502,stroke:#fff,stroke-width:2px,color:#fff
    style E fill:#ff6b8a,stroke:#fff,stroke-width:2px,color:#fff
    style F fill:#4facfe,stroke:#fff,stroke-width:2px,color:#fff
        </div>
      </div>
    </div>

    <div class="card table-section">
      <h2>Step-by-Step Process Analysis</h2>
      <div class="table-container">
        <div id="tableWrap" class="table-wrap"></div>
        
        <div class="quick-ref">
          <h3>MRI Source Files</h3>
          <ul>
            <li><code>eval.c</code> — Main exception raising logic (<strong>rb_raise</strong>)</li>
            <li><code>error.c</code> — Exception object creation (<strong>rb_exc_new_str</strong>)</li>
            <li><code>vm.c</code> — Virtual machine state capture (<strong>rb_vm_make_exception</strong>)</li>
            <li><code>vm_core.h</code> — Control frame structures (<strong>rb_control_frame_t</strong>)</li>
            <li><code>vm_backtrace.c</code> — Backtrace formatting (<strong>location_to_str</strong>)</li>
          </ul>
          
          <h3>Key Data Structures</h3>
          <ul>
            <li><code>rb_execution_context_t</code> — Thread execution context</li>
            <li><code>rb_control_frame_t</code> — Call stack frame info</li>
            <li><code>rb_iseq_t</code> — Instruction sequence (method bytecode)</li>
            <li><code>Thread::Backtrace::Location</code> — Ruby backtrace location object</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="card examples-section">
      <h2>🔍 Real-World Examples</h2>
      <div class="examples-intro">
        <p>These examples show <strong>actual code and data structures</strong> from Ruby's MRI implementation. Each example corresponds to a specific step in the backtrace creation process, with real file paths and function signatures you'd find in the Ruby source code.</p>
      </div>
      <div class="examples-grid">
        
        <div class="example-card">
          <h4>1. Ruby Application Code</h4>
          <div class="example-explanation">
            <p><strong>Where it all begins:</strong> This is typical Rails controller code where an exception might occur. The <code>raise</code> statement triggers the entire backtrace creation process.</p>
          </div>
          <div class="code-block">
            <div class="file-header">📁 app/controllers/users_controller.rb:42</div>
            <pre><code class="ruby">def create
  user = User.create!(user_params)
  render json: user
rescue ActiveRecord::ValidationError => e
  raise CustomError.new("User creation failed", e)
end</code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>2. MRI C Code Entry Point</h4>
          <div class="example-explanation">
            <p><strong>The gateway to C-land:</strong> When Ruby executes <code>raise</code>, it calls this C function. This is where Ruby's interpreter takes control and begins the backtrace process.</p>
          </div>
          <div class="code-block">
            <div class="file-header">🔧 eval.c:678 - rb_raise()</div>
            <pre><code class="c">void rb_raise(VALUE exc, const char *fmt, ...) {
    va_list args;
    va_start(args, fmt);
    rb_exc_raise(rb_exc_new_str_v(exc, fmt, args));
    va_end(args);
}</code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>3. Control Frame Structure</h4>
          <div class="example-explanation">
            <p><strong>The call stack blueprint:</strong> This C structure represents each method call in your program. Ruby maintains a linked list of these frames, forming the complete call stack.</p>
          </div>
          <div class="code-block">
            <div class="file-header">🏗️ vm_core.h:856 - rb_control_frame_t</div>
            <pre><code class="c">typedef struct {
    const VALUE *pc;     /* program counter */
    VALUE *sp;           /* stack pointer */
    const rb_iseq_t *iseq; /* instruction sequence */
    VALUE self;
    const VALUE *ep;     /* environment pointer */
} rb_control_frame_t;</code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>4. Backtrace Location Object</h4>
          <div class="example-explanation">
            <p><strong>Formatting for humans:</strong> This function takes raw VM data and converts it into the readable backtrace format you see in error messages. Each line of a backtrace comes from this function.</p>
          </div>
          <div class="code-block">
            <div class="file-header">🌍 vm_backtrace.c:234 - location_to_str()</div>
            <pre><code class="c">static VALUE location_to_str(rb_backtrace_location_t *loc) {
    return rb_sprintf("%s:%d:in `%s'",
                     RSTRING_PTR(loc->path),
                     loc->lineno,
                     RSTRING_PTR(loc->label));
}</code></pre>
          </div>
        </div>

        <div class="example-card span-2">
          <h4>5. Complete Stack Trace Example</h4>
          <div class="example-explanation">
            <p><strong>The final product:</strong> This is what you see in your terminal when an exception occurs. Each line represents one control frame from the call stack, formatted by the functions shown above. Reading from bottom to top shows the execution path.</p>
          </div>
          <div class="code-block">
            <div class="file-header">📊 Final backtrace output</div>
            <pre><code class="bash">Traceback (most recent call last):
    7: from app/controllers/application_controller.rb:12:in `process_action'
    6: from app/controllers/users_controller.rb:8:in `create'
    5: from app/models/user.rb:25:in `create!'
    4: from app/models/concerns/validatable.rb:15:in `validate_email'
    3: from lib/email_validator.rb:32:in `valid?'
    2: from lib/dns_checker.rb:18:in `mx_exists?'
    1: from /usr/local/lib/ruby/3.2.0/resolv.rb:297:in `each_resource'
app/controllers/users_controller.rb:42:in `create': User creation failed (CustomError)</code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>6. VM State During Exception</h4>
          <div class="example-explanation">
            <p><strong>Walking the stack:</strong> This shows how Ruby's VM traverses the control frame chain to gather backtrace information. It's like walking backwards through your program's execution history.</p>
          </div>
          <div class="code-block">
            <div class="file-header">⚙️ vm.c:2156 - rb_vm_make_exception()</div>
            <pre><code class="c">VALUE rb_vm_make_exception(int argc, const VALUE *argv, 
                          VALUE mesg) {
    rb_execution_context_t *ec = GET_EC();
    rb_control_frame_t *cfp = ec->cfp;
    
    // Walk the control frame stack
    while (cfp != ec->vm_stack + ec->vm_stack_size) {
        if (cfp->iseq && cfp->iseq->body) {
            // Extract location info
        }
        cfp = RUBY_VM_PREVIOUS_CONTROL_FRAME(cfp);
    }
}</code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>7. Thread::Backtrace::Location</h4>
          <div class="example-explanation">
            <p><strong>Ruby's public interface:</strong> This is the Ruby object that wraps the C-level location data. You can access these objects directly for programmatic backtrace analysis in your Ruby code.</p>
          </div>
          <div class="code-block">
            <div class="file-header">🧵 Ruby backtrace location object</div>
            <pre><code class="ruby"># Each location in the backtrace array:
location = Thread::Backtrace::Location.new
location.path     # => "/app/models/user.rb"
location.lineno   # => 25
location.label    # => "validate_email"
location.to_s     # => "/app/models/user.rb:25:in `validate_email'"</code></pre>
          </div>
        </div></code></pre>
          </div>
        </div>

        <div class="example-card">
          <h4>7. Thread::Backtrace::Location</h4>
          <div class="code-block">
            <div class="file-header">🧵 Ruby backtrace location object</div>
            <pre><code class="ruby"># Each location in the backtrace array:
location = Thread::Backtrace::Location.new
location.path     # => "/app/models/user.rb"
location.lineno   # => 25
location.label    # => "validate_email"
location.to_s     # => "/app/models/user.rb:25:in `validate_email'"</code></pre>
          </div>
        </div>
        
      </div>
    </div>
      <h2>📝 Embedded CSV Data</h2>
      <textarea id="csvText" class="csv-editor" placeholder="Edit the CSV data here...">
Sr,component,action,c_function_or_struct,example_files,realistic_example
1,"Ruby Code","raise 'error'","N/A","app/controllers/users_controller.rb:42","def create; User.create!(params); rescue => e; raise CustomError.new('User creation failed', e); end"
2,"Ruby VM (C)","rb_raise entry","rb_raise() in eval.c","MRI source: eval.c:678","rb_raise(rb_eStandardError, ""User creation failed"") - C function called from Ruby"
3,"Exception Object Creation","rb_exc_new_str","rb_exc_new_str() in error.c","MRI source: error.c:1891","Creates Exception instance with message, sets up basic structure before backtrace"
4,"VM State Capture","rb_vm_make_exception","rb_vm_make_exception() in vm.c","MRI source: vm.c:2156","Captures current rb_execution_context_t *ec and rb_control_frame_t *cfp chain"
5,"Control Frame Walk","cfp iteration","rb_control_frame_t in vm_core.h","MRI source: vm_core.h:856","Walk cfp stack: cfp->iseq->body->location.first_lineno, cfp->pc for exact line"
6,"Location Array Build","rb_ec_backtrace_to_location_ary","rb_ec_backtrace_to_location_ary() in vm_backtrace.c","MRI source: vm_backtrace.c:598","Creates Thread::Backtrace::Location objects with path=/app/models/user.rb, lineno=25"
7,"String Conversion","location_to_str","location_to_str() in vm_backtrace.c","MRI source: vm_backtrace.c:234","Formats as '/app/models/user.rb:25:in `validate_email'' - the familiar backtrace format"
8,"Exception Attachment","exc->bt_locations","Exception bt_locations attr","Ruby Exception object","exc.instance_variable_set(:@bt_locations, locations_ary) - internal storage"
9,"Ruby Level Access","Exception#backtrace","rb_backtrace_to_str_ary() in vm_backtrace.c","MRI source: vm_backtrace.c:552","Returns ['/app/controllers/users_controller.rb:42:in `create'', '/app/models/user.rb:25:in `validate_email'']"
      </textarea>
    </div>
  </div>

<script>
  function parseCSV(csv) {
    const lines = csv.trim().split(/\r?\n/);
    const headers = lines.shift().split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/^"|"$/g,''));
    const rows = lines.map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/^"|"$/g,''));
      const obj = {};
      headers.forEach((h,i)=> obj[h]=cols[i]||'');
      return obj;
    });
    return { headers, rows };
  }

  function renderTable(csvText) {
    const parsed = parseCSV(csvText);
    const tableWrap = document.getElementById('tableWrap');
    const table = document.createElement('table');
    
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    parsed.headers.forEach(h => { 
      const th = document.createElement('th'); 
      th.textContent = h; 
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    parsed.rows.forEach((r, index) => {
      const tr = document.createElement('tr');
      parsed.headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = r[h] || '';
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    
    tableWrap.innerHTML = '';
    tableWrap.appendChild(table);
  }

  // Toggle functionality with smooth animations
  function toggleCard(id) { 
    const el = document.getElementById(id); 
    if (el.style.display === 'none') {
      el.style.display = 'block';
      el.style.opacity = '0';
      el.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        el.style.transition = 'all 0.3s ease';
        el.style.opacity = '1';
        el.style.transform = 'translateY(0)';
      }, 10);
    } else {
      el.style.transition = 'all 0.3s ease';
      el.style.opacity = '0';
      el.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        el.style.display = 'none';
      }, 300);
    }
  }

  // Event listeners
  document.getElementById('toggleSeq').onclick = () => toggleCard('sequenceCard');
  document.getElementById('toggleFlow').onclick = () => toggleCard('flowCard');
  document.getElementById('toggleClass').onclick = () => toggleCard('classCard');
  document.getElementById('toggleCompact').onclick = () => toggleCard('compactCard');

  // Enhanced CSV download with timestamp
  document.getElementById('downloadCsv').addEventListener('click', function(){
    const text = document.getElementById('csvText').value;
    const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const timestamp = new Date().toISOString().split('T')[0];
    a.href = url;
    a.download = `ruby_exception_backtrace_${timestamp}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Initialize
  window.onload = function(){
    renderTable(document.getElementById('csvText').value);
    
    // Add some entrance animations
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
      card.style.opacity = '0';
      card.style.transform = 'translateY(30px)';
      setTimeout(() => {
        card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      }, index * 100);
    });
  };

  // Real-time CSV editing
  document.getElementById('csvText').addEventListener('input', function(){
    renderTable(this.value);
  });

  // Add smooth scrolling for better UX
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
</script>
</body>
</html>
